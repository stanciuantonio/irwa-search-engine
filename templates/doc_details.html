{% extends "base.html" %}
{% block page_title %}{{ doc.title if doc else 'Product Details' }}{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="javascript:history.back()">Results</a></li>
            <li class="breadcrumb-item active" aria-current="page">Product Details</li>
        </ol>
    </nav>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% elif doc %}
        <div class="row">
            <!-- Product Images Column -->
            <div class="col-lg-5 mb-4">
                <div class="product-gallery">
                    <!-- Main Image -->
                    <div class="main-image-container mb-3">
                        {% if doc.images and doc.images|length > 0 %}
                            <img src="{{ doc.images[0] }}" alt="{{ doc.title }}" class="main-product-image" id="mainImage">
                        {% else %}
                            <div class="no-image-placeholder">
                                <span>No Image Available</span>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Thumbnail Gallery -->
                    {% if doc.images and doc.images|length > 1 %}
                    <div class="thumbnail-gallery">
                        {% for img in doc.images[:5] %}
                        <div class="thumbnail {% if loop.first %}active{% endif %}" onclick="changeImage('{{ img }}', this)">
                            <img src="{{ img }}" alt="Product view {{ loop.index }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info Column -->
            <div class="col-lg-7">
                <div class="product-details-info">

                    <!-- Brand -->
                    {% if doc.brand %}
                    <p class="product-brand text-uppercase text-muted mb-2">{{ doc.brand }}</p>
                    {% endif %}

                    <!-- Title -->
                    <h1 class="product-detail-title mb-3">{{ doc.title }}</h1>

                    <!-- Rating -->
                    {% if doc.average_rating %}
                    <div class="product-rating mb-3">
                        <div class="stars">
                            {% set full_stars = doc.average_rating|int %}
                            {% set has_half = (doc.average_rating - full_stars) >= 0.5 %}
                            {% for i in range(full_stars) %}
                                <span class="star filled">&#9733;</span>
                            {% endfor %}
                            {% if has_half %}
                                <span class="star half">&#9733;</span>
                            {% endif %}
                            {% for i in range(5 - full_stars - (1 if has_half else 0)) %}
                                <span class="star">&#9733;</span>
                            {% endfor %}
                        </div>
                        <span class="rating-value">{{ doc.average_rating }}/5</span>
                    </div>
                    {% endif %}

                    <!-- Price Section -->
                    <div class="price-section mb-4">
                        {% if doc.selling_price %}
                        <span class="current-price">${{ "%.2f"|format(doc.selling_price) }}</span>
                        {% endif %}

                        {% if doc.actual_price and doc.actual_price != doc.selling_price %}
                        <span class="original-price">${{ "%.2f"|format(doc.actual_price) }}</span>
                        {% endif %}

                        {% if doc.discount and doc.discount > 0 %}
                        <span class="discount-badge">-{{ doc.discount|int }}% OFF</span>
                        {% endif %}
                    </div>

                    <!-- Stock Status -->
                    <div class="stock-status mb-4">
                        {% if doc.out_of_stock %}
                            <span class="badge badge-danger stock-badge">Out of Stock</span>
                        {% else %}
                            <span class="badge badge-success stock-badge">In Stock</span>
                        {% endif %}
                    </div>

                    <!-- Category Info -->
                    <div class="category-info mb-4">
                        <p class="mb-1">
                            <strong>Category:</strong>
                            {{ doc.category or 'N/A' }}
                            {% if doc.sub_category %} &rarr; {{ doc.sub_category }}{% endif %}
                        </p>
                        {% if doc.seller %}
                        <p class="mb-1"><strong>Seller:</strong> {{ doc.seller }}</p>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    {% if doc.description %}
                    <div class="product-description mb-4">
                        <h5 class="section-title">Description</h5>
                        <p class="description-text">{{ doc.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Product Specifications -->
                    {% if doc.product_details %}
                    <div class="product-specs mb-4">
                        <h5 class="section-title">Specifications</h5>
                        <div class="specs-grid">
                            {% for key, value in doc.product_details.items() %}
                            <div class="spec-item">
                                <span class="spec-label">{{ key }}</span>
                                <span class="spec-value">{{ value }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- External Link -->
                    {% if doc.url %}
                    <div class="external-link mb-4">
                        <a href="{{ doc.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-dark btn-lg">
                            View on Original Site &rarr;
                        </a>
                    </div>
                    {% endif %}

                    <!-- Product ID -->
                    <div class="product-id text-muted small mt-4">
                        <strong>Product ID:</strong> <code>{{ doc.pid }}</code>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-5 pt-4 border-top">
            <a href="javascript:history.back()" class="btn btn-dark">
                &larr; Back to Results
            </a>
        </div>

    {% else %}
        <div class="alert alert-warning text-center py-5">
            <h4>Product Not Found</h4>
            <p class="mb-0">The requested product could not be found.</p>
            <a href="/" class="btn btn-primary mt-3">Go to Home</a>
        </div>
    {% endif %}
</div>

<style>
/* Product Gallery */
.main-image-container {
    background-color: var(--color-gray-light);
    border-radius: 12px;
    padding: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
}

.main-product-image {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
}

.no-image-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--color-gray-dark);
}

.thumbnail-gallery {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.thumbnail {
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    background-color: var(--color-gray-light);
    transition: border-color 0.2s ease;
}

.thumbnail:hover,
.thumbnail.active {
    border-color: var(--color-black);
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Product Info */
.product-brand {
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 1px;
}

.product-detail-title {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.3;
}

/* Rating */
.product-rating {
    display: flex;
    align-items: center;
    gap: 10px;
}

.stars {
    display: flex;
    gap: 2px;
}

.star {
    color: #ddd;
    font-size: 1.25rem;
}

.star.filled {
    color: #ffc107;
}

.star.half {
    background: linear-gradient(90deg, #ffc107 50%, #ddd 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.rating-value {
    font-weight: 600;
    color: var(--color-gray-dark);
}

/* Price */
.price-section {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.current-price {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-black);
}

.original-price {
    font-size: 1.25rem;
    color: var(--color-gray-dark);
    text-decoration: line-through;
}

.discount-badge {
    background-color: #dc3545;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

/* Stock */
.stock-badge {
    font-size: 0.875rem;
    padding: 8px 16px;
    border-radius: 20px;
}

/* Sections */
.section-title {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-gray-light);
}

.description-text {
    color: #555;
    line-height: 1.7;
}

/* Specifications Grid */
.specs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

.spec-item {
    background-color: var(--color-gray-light);
    padding: 12px 16px;
    border-radius: 8px;
}

.spec-label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--color-gray-dark);
    margin-bottom: 4px;
}

.spec-value {
    display: block;
    font-weight: 600;
    color: var(--color-black);
}

/* Category Info */
.category-info {
    background-color: var(--color-gray-light);
    padding: 1rem 1.25rem;
    border-radius: 8px;
}

.category-info p {
    margin: 0;
    font-size: 0.9rem;
}

.category-info p + p {
    margin-top: 0.5rem;
}
</style>

<script>
function changeImage(src, element) {
    document.getElementById('mainImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
}
</script>
{% endblock %}
